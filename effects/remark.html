<!DOCTYPE html>
<html>
  <head>
    <title>My Awesome Presentation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">     
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif);
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }

      /* Two-column layout */
      .left-column {
        color: #777;
        width: 60%;
        height: 92%;
        float: left;
      }
      .left-column h2:last-of-type, .left-column h3:last-child {
        color: #000;
      }
      .right-column {
        width: 30%;
        float: right;
      }
      .question {
        font-size: 48pt;
      }
      .question-with-padding {
        font-size: 48pt;
        padding-top: 10%;
      }
      .bottom {
        margin-top: 50%
      }
      /* Two-column layout 50 /50  */
      .left-column-50 {
        width: 46%;
        float: left;
      }
      .right-column-50 {
        width: 46%;
        float: right;
      }
      .column-25 {
        padding-left: 5%;
        width: 20%;
        float: left;
      }
      .center-text {
        text-align: center;
        display: block;
      }
      .left {
        float: left;
      }
      .right {
        float: right;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# From side-effects to manageable effects

---
# Some frontend code
```javascript
var URL = 'https://api.giphy.com/v1/gifs/random?api_key=dc6zaTOxFJmzC&tag=cats';

function app() {
  document.querySelector('button').addEventListener(
    'click',
    () => fetch(URL)
      .then(response => response.json().data.image_url)
      .then(gifSrc => document.querySelector('img').setAttribute('src', gifSrc))
  );
}
```

### Effects: 
 - DOM: `document`, `setAttribute`
 - HTTP: `fetch`
---
# Key properties of side-effects
 + Not first-class citizen
  - Can not be passed as an argument
  - Can not be returned from a function
  - Can not be assigned to a variable
 + Depends on the "outside world"
 + Infects "side-effects free" code

## What this means for practice?
 - Сomplexity for analysis(for human and tools)
 - Сomplexity for refactoring
 - Сomplexity for reusing
 - Hard testing
 - Unpredictability and irreproducible
 - Inability to typify(Flow, TypeScript etc.)
 - Impossibility of an interactive development(REPL)
 - Complexity in providing certain properties of program
---

# Сomplexity for analysis
.left-column-50[
```javascript
function calcAnything(value) {
  var a = calcA(value);
  var b = calcB(value);
  return сalcC(value, b);
}
```
vs
```javascript
function doSomething() {
  var a = doSomethingA(value);
  var b = doSomethingB(value);
  return doSomethingC(value, b);
}
```
]
.right-column-50[
  ![Scheme of control flow](./img/analyze.svg)
  .question[
    ?
  ]
]
---
# Сomplexity for refactoring
.left-column-50[
```javascript
function calcAnything(value) {
  var a = calcA(value);
  var b = calcB(value);
  return сalcC(value, b);
}
```
vs
```javascript
function doSomething() {
  var a = doSomethingA(value);
  var b = doSomethingB(value);
  return doSomethingC(value, b);
}
```
]
.right-column-50[
```javascript
function calcAnything(value) {
  return сalcC(value, calcB(value));
}
```
.question-with-padding[
  ?
]
]
---
# Сomplication reuse
.left-column[
```javascript
function calcLengthAndSum() { ... }

function calcLength(list) {
  return calcLengthAndSum(list).length;
}
function calcMean(list) {
  var res = calcLengthAndSum(list);
  return res.sum / res.length;
}

```
vs
```javascript
function sendRequestAndWriteFile() { ... }

function sendRequest() {
  return sendRequestAndWriteFile({
    onlyRequest: true
  });
}
function sendRequestAndWriteFileOnUrl(url) {
  return sendRequestAndWriteFile({ url: url })
}
```
]
.right-column[
  ![Scheme calcLengthAndSum](./img/calcLengthAndSum.svg)
  .bottom[
    ![Scheme sendRequestAndWriteFile](./img/sendRequestAndWriteFile.svg)
  ]
]
---
# Hard testing
```javascript
it('2 + 2 = 4', () => {
  var result = add(2, 2);
  expect(result).toBe(4);
})
```
vs
```javascript
it('remoteAdd send args to endpoint', () => {
  var postCalls = [];
  var fakeRes = {};
  mock(HttpClient, { post: (...args) => {
    postCalls.push(args);
    return fakeRes;
  })
  var result = remoteAdd(2, 2);
  expect(postCalls.length).toBe(1);
  expect(postCalls[0]).toEqual({url: URL, params: {a: 2, b: 2}});
  expect(result).toBe(fakeRes);
});
```
TODO билд ве ворлд
Detailed article - [To Kill a Mockingtest](http://rea.tech/to-kill-a-mockingtest/)
---
# Unpredictability and irreproducible
> _Everything changes and nothing stands still_
>
> -- <cite>Heraclitus</cite>

```javascript
add(2, 2);
```
vs
```javascript
try {
  remoteAdd(2, 2);
} catch(e) {
  handleError(e);
}
```
```javascript
calc(a, b) === calc(a, b)
```
vs
```javascript
var res1 = fetchSomething(a);
// data on server changed
var res2 = fetchSomething(a);
res1 !== res2
```
---
# Inability to typify

```javascript
function parse(str: string): number | null  {
  return isLikeNumber(str) ? parseInt(str) : null;
}
function add(a: number, b: number) {
  return a + b;
}
add(parse('aaa'), 3) // compile-time error
```
But typing is not useful for side-effectful code:
```javascript
function patchDOM(patch: DOMPatch): void { ... }
function serverProgram() {
  ...
  patchDOM(patch); // run-time error
}
```
[Possible solution in Flow](https://medium.com/@gcanti/the-eff-monad-implemented-in-flow-40803670c3eb)
```javascript
type DB = { type: 'DB' };
type User = { username: string, uid: number };
function createUser(username: string): Eff<{ write: DB }, User> { ... }
function lookupUser(username: string): Eff<{ read: DB }, ?User> { ... }
```
---
# Impossibility of an interactive development

Tools: 
 - REPL(terminal, editor plugin, console)
 - Mancy
 - Light Table

![Light Table](./img/watches.png)

Articles:
 - http://tonsky.me/blog/interactive-development/

Possible solutions:
 - jest-repl
 - mocha debug repl
---
# Complexity in providing certain properties of program

Side-effects free functions has properties(like as math functions)
```javascript 
var sortIdempotent =
  jsc.forall("string -> nat", "array string", function (f, arr) {
    return _.isEqual(_.sortBy(_.sortBy(arr, f), f), _.sortBy(arr, f));
  });

jsc.assert(sortIdempotent);
```

Tools:
  - testcheck
  - js-verify
---
# Two kinds of programming
.left-column-50[
  ###Top-Down

  ![Top-Down](./img/top-down.svg)
  - Define top level API(without the implementation)
  - Define underlying API

  More consistent and correct, but less fast and agile

  Main tool: strong static types
]
.right-column-50[
  ###Bottom-Up

  ![Bottom-Up](./img/bottom-up.svg)
  - Implement low level API calls as isolated components
  - Compose them to secondary level API components

  More agile, fast, but less consistent
  
  Main tool: REPL
]

TODO рыцари и вывод
---
# Infects side-effects free code
.left-column[
```javascript
function calcForItem(...) {
  ...
  var cachedResult = localStorage
    .getItem(argsHash);
  if (cachedResult) {
    return cachedResult;
  } else {
    ...
    localStorage.setItem(argsHash, res)
    return res;
  }
}
```
]
.right-column[
![Pure to not pure](./img/pure_to_not_pure_tree.svg)
]
---
# Two-color language
> _In Soviet Russia side-effects control you!_

Links:
 - [Article Bob Nystrom](http://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/)
 - [Talk Andrey Salomatin](https://www.youtube.com/watch?v=OGSppLmGchY)

```javascript
blue•function doSomethingAzure() {
  // This is a blue function...
}
red•function doSomethingCarnelian() {
  // This is a red function...
}

blue•function doSomethingAzure() {
  doSomethingCarnelian()•red;  // Error - you cant call red inside blue
}
```

Two different kinds of program code:

 - execution or outside calcultation(side-effects) - red functions
 - calculation(pure) - blue functions 
---
    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>